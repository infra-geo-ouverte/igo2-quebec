<mat-sidenav-container>
  <mat-sidenav-content position="end">
    <app-panels-handler
      [searchState]="searchState"
      [searchBar]="searchBar"
      [map]="map"
    ></app-panels-handler>
    @if (!mobile) {
      <div id="searchDesktop">
        @if (showSearchBar) {
          <ng-container *ngTemplateOutlet="searchBar"></ng-container>
        }
        @if (mobile) {
          <div id="scaleLine"></div>
        }
        <app-sidepanel
          #sidepanel
          class="sidepanel"
          [searchState]="searchState"
          [map]="map"
          [mobile]="mobile"
          [(opened)]="panelOpenState"
          [searchInit]="searchInit"
          [legendPanelOpened]="legendPanelOpened"
          [mapQueryClick]="mapQueryClick"
          [panelOpenState]="panelOpenState"
          (panelOpened)="panelOpened($event)"
          (closeLegend)="closePanelLegend()"
          (closeQuery)="closePanelOnCloseQuery()"
          (openLegend)="openPanelLegend()"
          [layers]="mapLayersShownInLegend"
        >
        </app-sidepanel>
      </div>
    }

    <igo-map-browser
      igoMapOffline
      igoMapContext
      igoLayerContext
      igoDropGeoFile
      igoHoverFeature
      [igoHoverFeatureEnabled]="true"
      igoQuery
      [queryFeatures]="true"
      (query)="onMapQuery($event)"
      [igoHoverFeatureDelay]="10"
      [map]="map"
      [ngClass]="{
        'igo-attribution-offset': map.getBaseLayers().length > 1,
        'map-hasfooter': hasFooter
      }"
    >
      @if (mobile) {
        <div id="scaleLine"></div>
      }

      <igo-baselayers-switcher
        [ngClass]="
          mobile
            ? !hasFooter
              ? 'igo-baselayers-switcher-mobile footer-mobile-offset'
              : 'igo-baselayers-switcher-mobile'
            : panelOpenState
              ? 'baselayers-pushed'
              : 'baselayers'
        "
        [map]="map"
        [useStaticIcon]="appConfig.useStaticIcon"
      >
      </igo-baselayers-switcher>

      <div
        id="map-buttons"
        [ngClass]="
          !hasFooter
            ? mobile
              ? 'map-buttons-mobile footer-mobile-offset'
              : 'map-buttons'
            : mobile
              ? 'map-buttons-mobile'
              : 'map-buttons'
        "
      >
        @if (hasGeolocateButton) {
          <igo-geolocate-button
            [map]="map"
            color="primary"
          ></igo-geolocate-button>
        }
        <igo-zoom-button [map]="map" color="primary"></igo-zoom-button>
        <igo-rotation-button
          [showIfNoRotation]="appConfig.showRotationButtonIfNoRotation"
          [map]="map"
          color="primary"
        ></igo-rotation-button>
        @if (appConfig.hasLegendButton) {
          <app-legend-button
            (legendToggled)="togglePanelComponent(shownComponents.Legend)"
            [legendInPanel]="appConfig.legendInPanel"
            [tooltipDisabled]="mobile"
            color="primary"
          ></app-legend-button>
        }
      </div>

      @if (mobile) {
        <app-bottompanel
          [searchState]="searchState"
          [mobile]="mobile"
          [searchInit]="searchInit"
          [mapQueryClick]="mapQueryClick"
          [legendPanelOpened]="legendPanelOpened"
          [panelOpenState]="panelOpenState"
          (panelOpened)="panelOpened($event)"
          (mapQuery)="mapQuery($event)"
          (closeQuery)="closePanelOnCloseQuery()"
          (closeLegend)="closePanelLegend()"
          (openLegend)="openPanelLegend()"
          [layers]="mapLayersShownInLegend"
        >
        </app-bottompanel>
      }
    </igo-map-browser>

    @if (hasFooter && !mobile) {
      <app-footer></app-footer>
    }

    <app-map-overlay
      [@controlStateX]="
        (mediaService.media$ | async) !== 'mobile' && panelOpenState
          ? 'right'
          : 'left'
      "
    >
    </app-map-overlay>
  </mat-sidenav-content>
</mat-sidenav-container>

<ng-template #searchBar>
  <igo-search-bar
    (click)="$event.stopPropagation()"
    appearance="outline"
    searchIcon="magnify"
    [matTooltip]="'searchBar' | translate"
    matTooltipShowDelay="500"
    tooltip-position="after"
    [searchSettings]="false"
    color="primary"
    [forceNA]="appConfig.app?.forceCoordsNA"
    [term]="searchState.searchTerm$ | async"
    [store]="searchStore"
    (searchTermChange)="onSearchTermChange($event)"
    (search)="onSearch($event)"
    (clearFeature)="clearSearch()"
  >
  </igo-search-bar>
</ng-template>
